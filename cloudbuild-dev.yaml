steps:
# Compile
- name: 'gcr.io/cloud-builders/go'
  id: 'Compile application'
  env: ['GOPATH=/gopath']
  args: ['build', '-o', 'main', 'main.go']

# Build image
- name: 'gcr.io/cloud-builders/docker'
  id: 'Build Docker image'
  args:
  - 'build'
  - '-t'
  - 'us-east1-docker.pkg.dev/$PROJECT_ID/my-repository/hello-cloudbuild-dev:v2.0'
  - '.'

# Push image
- name: 'gcr.io/cloud-builders/docker'
  id: 'Push Docker image'
  args:
  - 'push'
  - 'us-east1-docker.pkg.dev/$PROJECT_ID/my-repository/hello-cloudbuild-dev:v2.0'

# Deploy to dev namespace
- name: 'gcr.io/cloud-builders/kubectl'
  id: 'Deploy'
  env:
  - 'CLOUDSDK_COMPUTE_ZONE=us-east1-b'
  - 'CLOUDSDK_CONTAINER_CLUSTER=hello-cluster'
  args:
  - '-n'
  - 'dev'
  - 'apply'
  - '-f'
  - 'dev/deployment.yaml'
